<!-- orders.html -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <title>React Tutorial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    
  </head>
  <body>
    <nav class="navbar navbar-default">
      <div class="container-fluid">
      <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <a class="navbar-brand" href="#">Pedidos</a>
        </div>
      </div>
    </nav>

    <div class="container" id="content">
    </div>

    <script type="text/babel">
      var data = [{amount: 5, orderId: "1"}, {amount: 12, orderId: "2"}];

      var OrderList = React.createClass({

        getInitialState: function() {
          return {data: []};
        },
        componentDidMount: function() {
          $.ajax({
            url: this.props.url,
            dataType: 'json',
            cache: false,
            success: function(data) {
              console.log(data[0]);
              this.setState({data: data});
            }.bind(this),
            error: function(xhr, status, err) {
              console.error(this.props.url, status, err.toString());
            }.bind(this)
          });
        },
        render: function() {
          var orderNodes = this.state.data.map(function (order) {
            return (
              <Order data={order} key={order.nonce}/>
            );
          });

          return (
            <div className="li">
              {orderNodes}
            </div>
          );
        }
      });

      var Item = React.createClass({
        render: function () {
          return (
            <div className="row">
              <div className="col-md-3">
                {this.props.line.quantity} x
              </div>
              <div className="col-md-5">
                {this.props.line.item.name}
              </div>
              <div className="col-md-4">
                <button type="button" className="btn btn-success">Listo</button>
              </div>
            </div>
          );
        }
      });

      var Order = React.createClass({
        updateTimeElapsed : function() {
          var minsElapsed = (((Date.now() - this.props.data.timestamp) / 1000) / 60).toFixed(0);
          
          this.setState({elapsed: minsElapsed});
        },
        componentDidMount: function() {
          // this.setState({elapsed: (((Date.now() - this.props.data.timestamp) / 1000) / 60).toFixed(0)});
          setInterval(this.updateTimeElapsed, 60 * 1000);
        },
        getInitialState: function(){
          return ({elapsed: (((Date.now() - this.props.data.timestamp) / 1000) / 60).toFixed(0)});
        },
        render: function() {
          var itemArray = [];
          var itemListObject = this.props.data.itemList;

          Object.keys(itemListObject).forEach(function (key) {
            itemArray.push(itemListObject[key]);
          });

          var itemNodes = itemArray.map( function (purchase) {
            return (
              <Item line={purchase} key={purchase.item._id}/>
            );
          });

          return (
            <div className="panel panel-info" >
              <div className="panel-heading">
                <div className="panel-title">
                {this.props.data.address.street}, {this.props.data.address.floor}
                <h2> Tiempo {this.state.elapsed} min</h2>
                </div>
              </div>
              <div className="panel-body">
                Hello, world! Cost = {this.props.data.amount}
                {itemNodes}
              </div>
            </div>
          );
        }
      });

      React.render(
        <OrderList url="/api/orders"/>,
        document.getElementById('content')
      );

      
      // To get started with this tutorial running your own code, simply remove
      // the script tag loading scripts/example.js and start writing code here.
    </script>
  </body>
</html>